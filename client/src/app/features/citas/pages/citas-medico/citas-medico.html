<div class="container">
    
  <div class="header">
    <h1>Mis Citas</h1>
    <p class="bienvenida">Bienvenido, Dr(a). {{ nombreMedico }}</p>
    <div class="stats">
      <div class="stat-card stat-solicitada">
        <span class="stat-number">{{ contarPorEstado('solicitada') }}</span>
        <span class="stat-label">Solicitadas</span>
      </div>
      <div class="stat-card stat-confirmada">
        <span class="stat-number">{{ contarPorEstado('confirmada') }}</span>
        <span class="stat-label">Confirmadas</span>
      </div>
      <div class="stat-card stat-completada">
        <span class="stat-number">{{ contarPorEstado('completada') }}</span>
        <span class="stat-label">Completadas</span>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filtros">
    <label>Filtrar por estado:</label>
    <select [(ngModel)]="filtroEstado" class="form-control">
      <option value="todas">Todas las citas</option>
      <option value="solicitada">Solicitadas</option>
      <option value="confirmada">Confirmadas</option>
      <option value="completada">Completadas</option>
      <option value="cancelada">Canceladas</option>
    </select>
  </div>

  <div *ngIf="loading" class="loading">
    Cargando citas...
  </div>

  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <div *ngIf="!loading && citasFiltradas.length === 0" class="empty">
    No tienes citas {{ filtroEstado !== 'todas' ? 'con estado: ' + filtroEstado : '' }}
  </div>

  <div class="citas-grid">
    <div *ngFor="let cita of citasFiltradas" class="cita-card">
      <div class="cita-header">
        <div>
          <span class="fecha">{{ cita.fecha_cita | date:'dd/MM/yyyy HH:mm' }}</span>
          <span class="duracion">{{ cita.duracion }} min</span>
        </div>
        <span class="estado" [ngClass]="getEstadoClass(cita.estado)">
          {{ cita.estado }}
        </span>
      </div>
      
      <div class="cita-body">
        <div class="paciente-info">
          <h3>{{ cita.paciente_nombre }}</h3>
          <p><strong>Email:</strong> {{ cita.paciente_email }}</p>
          <p *ngIf="cita.paciente_telefono"><strong>TelÃ©fono:</strong> {{ cita.paciente_telefono }}</p>
        </div>

        <div class="consulta-info">
          <p><strong>Tipo:</strong> {{ cita.tipo_consulta }}</p>
          <p><strong>Motivo:</strong> {{ cita.motivo_consulta }}</p>
          <p *ngIf="cita.notas_paciente"><strong>Notas del paciente:</strong> {{ cita.notas_paciente }}</p>
          <p *ngIf="cita.notas_medico" class="notas-medico">
            <strong>Mis notas:</strong> {{ cita.notas_medico }}
          </p>
        </div>
      </div>

      <!-- Acciones segÃºn estado -->
      <div class="cita-actions" *ngIf="esFutura(cita.fecha_cita)">
        <!-- Si estÃ¡ solicitada -->
        <ng-container *ngIf="cita.estado === 'solicitada'">
          <button class="btn btn-success" (click)="confirmarCita(cita)">
            âœ“ Confirmar
          </button>
          <button class="btn btn-danger" (click)="abrirModalRechazar(cita)">
            âœ— Rechazar
          </button>
        </ng-container>

        <!-- Si estÃ¡ confirmada -->
        <ng-container *ngIf="cita.estado === 'confirmada'">
          <button class="btn btn-primary" (click)="abrirModalCompletar(cita)">
            Marcar como Completada
          </button>
        </ng-container>
      </div>

      <!-- Mensaje si es pasada -->
      <div class="cita-pasada" *ngIf="!esFutura(cita.fecha_cita) && cita.estado === 'confirmada'">
        <p>âš ï¸ Esta cita ya pasÃ³. Puede marcarla como completada.</p>
        <button class="btn btn-primary btn-small" (click)="abrirModalCompletar(cita)">
          Marcar Completada
        </button>
      </div>
    </div>
  </div>
</div>



<!-- ========================================== -->
<!-- MODAL COMPLETAR CONSULTA (ADAPTATIVO)      -->
<!-- ========================================== -->
<div class="modal" *ngIf="mostrarModalCompletar">
  <div class="modal-overlay" (click)="cerrarModalCompletar()"></div>
  <div class="modal-content modal-historial">
    <button class="modal-close" (click)="cerrarModalCompletar()">âœ•</button>
    
    <h2>ğŸ“‹ Completar Consulta</h2>
    <p class="modal-paciente">Paciente: {{ citaACompletar?.paciente_nombre }}</p>
    
    <div class="historial-form">
      
      <!-- DiagnÃ³stico -->
      <div class="form-section">
        <h3>ğŸ©º DiagnÃ³stico *</h3>
        <textarea [(ngModel)]="diagnostico" rows="3" placeholder="DiagnÃ³stico principal..." class="form-control" required></textarea>
      </div>

      <!-- SÃ­ntomas -->
      <div class="form-section">
        <h3>ğŸ“ SÃ­ntomas</h3>
        <textarea [(ngModel)]="sintomas" rows="3" placeholder="SÃ­ntomas presentados..." class="form-control"></textarea>
      </div>

      <!-- Signos Vitales (Igual) -->
      <div class="form-section">
        <h3>â¤ï¸ Signos Vitales</h3>
        <div class="signos-grid">
          <div class="form-group">
            <label>PresiÃ³n Arterial</label>
            <input type="text" [(ngModel)]="presionArterial" placeholder="120/80" class="form-control">
          </div>
          <div class="form-group">
            <label>Temperatura (Â°C)</label>
            <input type="number" [(ngModel)]="temperatura" placeholder="36.5" step="0.1" class="form-control">
          </div>
          <div class="form-group">
            <label>Peso (kg)</label>
            <input type="number" [(ngModel)]="peso" placeholder="70" step="0.1" class="form-control">
          </div>
          <div class="form-group">
            <label>Altura (m)</label>
            <input type="number" [(ngModel)]="altura" placeholder="1.75" step="0.01" class="form-control">
          </div>
        </div>
      </div>

      <!-- ExploraciÃ³n FÃ­sica -->
      <div class="form-section">
        <h3>ğŸ” ExploraciÃ³n FÃ­sica</h3>
        <textarea [(ngModel)]="exploracionFisica" rows="3" placeholder="Hallazgos..." class="form-control"></textarea>
      </div>

      <!-- ====================================================== -->
      <!-- SECCIÃ“N DINÃMICA: RECETAS vs PLAN NUTRICIONAL          -->
      <!-- ====================================================== -->
      <div class="form-section recetas-section">
        <!-- TÃ­tulo Cambiante -->
        <h3>{{ tituloSeccionItems }}</h3>
        
        <!-- Lista de items agregados -->
        <div *ngIf="recetas.length > 0" class="recetas-lista">
          <div *ngFor="let receta of recetas; let i = index" class="receta-item">
            <div class="receta-info">
              <strong>{{ receta.medicamento_nombre }}</strong>
              <span *ngIf="receta.medicamento_generico">({{ receta.medicamento_generico }})</span>
              <p>{{ receta.dosis }} - {{ receta.frecuencia }} - {{ receta.duracion }}</p>
            </div>
            <button class="btn-eliminar" (click)="eliminarReceta(i)">ğŸ—‘ï¸</button>
          </div>
        </div>

        <!-- Formulario para agregar -->
        <div class="agregar-receta">
          <h4>{{ lblAgregarBtn }}</h4>
          <div class="receta-grid">
            
            <div class="form-group">
              <!-- Label DinÃ¡mico -->
              <label>{{ lblNombreItem }} *</label>
              <input type="text" [(ngModel)]="nuevaReceta.medicamento_nombre" 
                     [placeholder]="placeholderNombre" class="form-control">
            </div>
            
            <!-- Campo GenÃ©rico: Solo visible si NO es NutriÃ³logo -->
            <div class="form-group" *ngIf="!esNutriologo">
              <label>GenÃ©rico</label>
              <input type="text" [(ngModel)]="nuevaReceta.medicamento_generico" 
                     placeholder="AcetaminofÃ©n" class="form-control">
            </div>

            <div class="form-group">
              <label>{{ lblDosis }} *</label>
              <input type="text" [(ngModel)]="nuevaReceta.dosis" 
                     [placeholder]="placeholderDosis" class="form-control">
            </div>

            <div class="form-group">
              <label>{{ lblFrecuencia }} *</label>
              <input type="text" [(ngModel)]="nuevaReceta.frecuencia" 
                     [placeholder]="placeholderFrecuencia" class="form-control">
            </div>
            
            <div class="form-group">
              <label>DuraciÃ³n *</label>
              <input type="text" [(ngModel)]="nuevaReceta.duracion" 
                     placeholder="Ej. 5 dÃ­as / 1 semana" class="form-control">
            </div>

            <!-- VÃ­a de AdministraciÃ³n: Solo visible si NO es NutriÃ³logo -->
            <div class="form-group" *ngIf="!esNutriologo">
              <label>VÃ­a de AdministraciÃ³n</label>
              <select [(ngModel)]="nuevaReceta.via_administracion" class="form-control">
                <option value="Oral">Oral</option>
                <option value="Intravenosa">Intravenosa</option>
                <option value="Intramuscular">Intramuscular</option>
                <option value="TÃ³pica">TÃ³pica</option>
                <option value="Sublingual">Sublingual</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>{{ esNutriologo ? 'Notas / PreparaciÃ³n' : 'Indicaciones' }}</label>
            <textarea [(ngModel)]="nuevaReceta.indicaciones" rows="2" 
                      placeholder="..." class="form-control"></textarea>
          </div>

          <button class="btn btn-agregar" (click)="agregarReceta()">
            â• {{ lblAgregarBtn }}
          </button>
        </div>
      </div>
      <!-- ====================================================== -->

      <div class="form-section">
        <h3>ğŸ“‹ Plan de Tratamiento</h3>
        <textarea [(ngModel)]="planTratamiento" rows="3" placeholder="Indicaciones generales..." class="form-control"></textarea>
      </div>

      <div class="form-section">
        <h3>ğŸ“„ Observaciones</h3>
        <textarea [(ngModel)]="observaciones" rows="3" placeholder="Notas adicionales..." class="form-control"></textarea>
      </div>

      <div class="form-section">
        <h3>ğŸ“… Fecha de Seguimiento</h3>
        <input type="date" [(ngModel)]="fechaSeguimiento" class="form-control">
      </div>

    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="cerrarModalCompletar()">Cancelar</button>
      <button class="btn btn-primary" (click)="confirmarCompletar()">
        ğŸ’¾ Guardar {{ esNutriologo ? 'Plan' : 'Historial' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal Rechazar -->
<div class="modal" *ngIf="mostrarModalRechazar">
  <div class="modal-overlay" (click)="cerrarModalRechazar()"></div>
  <div class="modal-content">
    <h2>Rechazar Cita</h2>
    <p>Â¿Por quÃ© rechaza esta cita?</p>
    
    <div class="form-group">
      <label>Motivo:</label>
      <textarea 
        [(ngModel)]="motivoRechazo" 
        rows="3" 
        placeholder="Ej: No disponible, conflicto de horario..."
        class="form-control"></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="cerrarModalRechazar()">
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="confirmarRechazar()">
        Rechazar Cita
      </button>
    </div>
  </div>
</div>